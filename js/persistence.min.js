// persistence.js
function initPersistence(a){if(a.isImmutable)return a;a.isImmutable=function(a){return"id"==a},a.defineProp=function(a,b,c,d){"function"==typeof a.__defineSetter__&&"function"==typeof a.__defineGetter__?(a.__defineSetter__(b,function(a){c(a)}),a.__defineGetter__(b,function(){return d()})):Object.defineProperty(a,b,{get:d,set:function(a){c(a)},enumerable:!0,configurable:!0})},a.set=function(b,c,d){if(a.isImmutable(c))throw new Error("immutable field: "+c);b[c]=d},a.get=function(a,b){return 1==arguments.length?a:a[b]},function(){function e(a){return c[a]}function f(a){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=a}function g(f){function j(c,d){var j,k,l,m,g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"obj",optional:!0,check:function(a){return a},defaultValue:{}}]);if(h.isMixin)throw new Error("Cannot instantiate mixin");c=g.session,d=g.obj,j=this,this.id=d.id||a.createUUID(),this._new=!0,this._type=f,this._dirtyProperties={},this._data={},this._data_obj={},this._session=c||a,this.subscribers={};for(k in h.fields)!function(){if(h.fields.hasOwnProperty(k)){var b=k;a.defineProp(j,b,function(a){var d=j._data[b];(d!==a||d&&a&&d.getTime&&a.getTime)&&(j._data[b]=a,j._dirtyProperties[b]=d,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a),c.propertyChanged(j,b,d,a))},function(){return j._data[b]}),j._data[k]=i(h.fields[k])}}();for(l in h.hasOne)h.hasOne.hasOwnProperty(l)&&function(){var b=l,d=h.hasOne[l].type.meta.isMixin?b+"_class":null;a.defineProp(j,b,function(a){var g,i,e=j._data[b],f=j._data_obj[b]||c.trackedObjects[j._data[b]];null==a?(j._data[b]=null,j._data_obj[b]=void 0,d&&(j[d]="")):a.id?(j._data[b]=a.id,j._data_obj[b]=a,d&&(j[d]=a._type),c.add(a),c.add(j)):j._data[b]=a,j._dirtyProperties[b]=e,j.triggerEvent("set",j,b,a),j.triggerEvent("change",j,b,a),h.hasOne[b].inverseProperty&&(g=j[b],g&&(i=g[h.hasOne[b].inverseProperty],i.list&&i._filter&&i.triggerEvent("change",j,b,a)),f&&(i=f[h.hasOne[b].inverseProperty],i.list&&i._filter&&i.triggerEvent("change",j,b,a)))},function(){if(j._data[b]){if(void 0!==j._data_obj[b])return j._data_obj[b];if(j._data[b]&&c.trackedObjects[j._data[b]])return j._data_obj[b]=c.trackedObjects[j._data[b]],j._data_obj[b];throw new Error("Property '"+b+"' of '"+h.name+"' with id: "+j._data[b]+" not fetched, either prefetch it or fetch it manually.")}return null})}();for(l in h.hasMany)h.hasMany.hasOwnProperty(l)&&function(){var b=l;h.hasMany[b].manyToMany?a.defineProp(j,b,function(c){var d,e;if(!c||!c._items)throw new Error("Not yet supported.");for(d=c._items,e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){var d,e,f,g,i,k;return j._data[b]?j._data[b]:(d=h.hasMany[b],e=d.type.meta,f=e.hasMany[d.inverseProperty],g=d.mixin?d.mixin.meta.name:h.name,i=f.mixin?f.mixin.meta.name:e.name,k=new a.ManyToManyDbQueryCollection(c,e.name),k.initManyToMany(j,b),k._manyToManyFetch={table:d.tableName,prop:g+"_"+b,inverseProp:i+"_"+d.inverseProperty,id:j.id},j._data[b]=k,c.uniqueQueryCollection(k))}):a.defineProp(j,b,function(c){var d,e;if(!c||!c._items)throw new Error("Not yet supported.");for(d=c._items,e=0;e<d.length;e++)a.get(j,b).add(d[e])},function(){if(j._data[b])return j._data[b];var d=c.uniqueQueryCollection(new a.DbQueryCollection(c,h.hasMany[b].type.meta.name).filter(h.hasMany[b].inverseProperty,"=",j));return j._data[b]=d,d})}();this.initialize&&this.initialize();for(m in d)d.hasOwnProperty(m)&&"id"!==m&&a.set(j,m,d[m])}function k(b,c,d,f){var h,i,j,l,m,n,o,p;b._session,h=[],i=e(b._type),j=i.fields;for(l in d)d.hasOwnProperty(l)&&h.push(l);m=[],n=[],h.forEach(function(a){d[a]!==!0||i.hasMany[a]?n.push(a):m.push(a)}),o=b._data,p={},m.forEach(function(c){"id"===c?p.id=b.id:p[c]=i.hasOne[c]?o[c]?{id:o[c]}:null:a.entityValToJson(o[c],j[c])}),h=n.slice(),a.asyncForEach(h,function(e,f){i.hasOne[e]?b.fetch(c,e,function(a){a?k(a,c,d[e],function(a){p[e]=a,f()}):(p[e]=null,f())}):i.hasMany[e]&&a.get(b,e).list(function(b){p[e]=[],a.asyncForEach(b,function(a,f){var a=b.pop();d[e]===!0?(p[e].push({id:a.id}),f()):k(a,c,d[e],function(a){p[e].push(a),f()})},f)})},function(){f(p)})}var h,l,n;if(d[f])return d[f];h=c[f],j.prototype=new m,j.meta=h,j.prototype.equals=function(a){return this.id==a.id},j.prototype.toJSON=function(){var b,a={id:this.id};for(b in this._data)this._data.hasOwnProperty(b)&&("object"==typeof this._data[b]&&null!=this._data[b]?void 0!=this._data[b].toJSON&&(a[b]=this._data[b].toJSON()):a[b]=this._data[b]);return a},j.prototype.selectJSON=function(c,d,e){var i,f=this,g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);return c=g.tx,d=g.props,e=g.callback,c?(i={},d.forEach(function(a){var d,e,f,g,b=i,c=a.split(".");for(d=0;d<c.length;d++)if(e=c[d],d===c.length-1)if("*"===e){b.id=!0;for(f in h.fields)h.fields.hasOwnProperty(f)&&(b[f]=!0);for(f in h.hasOne)h.hasOne.hasOwnProperty(f)&&(b[f]=!0);for(f in h.hasMany)h.hasMany.hasOwnProperty(f)&&(b[f]=!0)}else"["===e[0]?(e=e.substring(1,e.length-1),g=e.split(/,\s*/),g.forEach(function(a){b[a]=!0})):b[e]=!0;else b[e]=b[e]||{},b=b[e]}),k(this,c,i,e),void 0):(this._session.transaction(function(a){f.selectJSON(a,d,e)}),void 0)},j.prototype.fetch=function(c,d,e){var i,j,k,f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:b.hasType("string")},{name:"callback",optional:!1,check:b.isCallback()}]);return c=f.tx,d=f.rel,e=f.callback,i=this,j=this._session,c?(this._data[d]?this._data_obj[d]?e&&e(this._data_obj[d]):(k=h.hasOne[d].type,k.meta.isMixin&&(k=g(this._data[d+"_class"])),k.load(j,c,this._data[d],function(a){i._data_obj[d]=a,e&&e(a)})):e&&e(null),void 0):(j.transaction(function(a){i.fetch(a,d,e)}),void 0)},j.prototype.markDirty=function(a){this._dirtyProperties[a]=!0},j.all=function(c){var d=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a}]);return c=d.session,c.uniqueQueryCollection(new t(c,f))},j.fromSelectJSON=function(c,d,e,f){function i(b){var g,i;b||(b=new j(c),e.id&&(b.id=e.id)),c.add(b),g=[];for(i in e)if(e.hasOwnProperty(i)){if("id"===i)continue;h.fields[i]?a.set(b,i,a.jsonToEntityVal(e[i],h.fields[i])):(h.hasOne[i]||h.hasMany[i])&&g.push(i)}a.asyncForEach(g,function(f,g){var i,j,k;h.hasOne[f]?h.hasOne[f].type.fromSelectJSON(c,d,e[f],function(c){a.set(b,f,c),g()}):h.hasMany[f]&&(i=a.get(b,f),j=e[f].slice(0),k=h.hasMany[f].type,i.list(d,function(b){a.asyncForEach(j,function(a,e){k.fromSelectJSON(c,d,a,function(a){for(var c=0;c<b.length;c++)if(b[c].id===a.id)return e(),void 0;i.add(a),e()})},function(){g()})}))},function(){f(b)})}var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:b.isCallback()}]);return c=g.session,d=g.tx,e=g.jsonObj,f=g.callback,d?("string"==typeof e&&(e=JSON.parse(e)),e?(e.id?j.load(c,d,e.id,i):i(new j(c)),void 0):(f(null),void 0)):(c.transaction(function(a){j.fromSelectJSON(c,a,e,f)}),void 0)},j.load=function(){var g=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"id",optional:!1,check:b.hasType("string")},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);j.findBy(g.session,g.tx,"id",g.id,g.callback)},j.findBy=function(c,d,e,f,g){var h=b.getArgs(arguments,[{name:"session",optional:!0,check:a.isSession,defaultValue:a},{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"property",optional:!1,check:b.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);return c=h.session,d=h.tx,e=h.property,f=h.value,g=h.callback,"id"===e&&f in c.trackedObjects?(g(c.trackedObjects[f]),void 0):d?(j.all(c).filter(e,"=",f).one(d,function(a){g(a)}),void 0):(c.transaction(function(a){j.findBy(c,a,e,f,g)}),void 0)},j.index=function(a,b){var c=b||{};"string"==typeof a&&(a=[a]),c.columns=a,h.indexes.push(c)},j.hasMany=function(b,c,d){var f,g,e=c.meta;e.hasMany[d]?(f=h.name+"_"+b+"_"+e.name,g=e.name+"_"+d+"_"+h.name,f>g&&(f=g),h.hasMany[b]={type:c,inverseProperty:d,manyToMany:!0,tableName:f},e.hasMany[d]={type:j,inverseProperty:b,manyToMany:!0,tableName:f},delete h.hasOne[b],delete h.fields[b+"_class"]):(h.hasMany[b]={type:c,inverseProperty:d},e.hasOne[d]={type:j,inverseProperty:b},h.isMixin&&(e.fields[d+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT"))},j.hasOne=function(b,c,d){h.hasOne[b]={type:c,inverseProperty:d},c.meta.isMixin&&(h.fields[b+"_class"]=a.typeMapper?a.typeMapper.classNameType:"TEXT")},j.is=function(a){var c,d,b=a.meta;if(!b.isMixin)throw new Error("not a mixin: "+a);a.meta.mixedIns=a.meta.mixedIns||[],a.meta.mixedIns.push(h);for(c in b.fields)b.fields.hasOwnProperty(c)&&(h.fields[c]=b.fields[c]);for(d in b.hasOne)b.hasOne.hasOwnProperty(d)&&(h.hasOne[d]=b.hasOne[d]);for(d in b.hasMany)b.hasMany.hasOwnProperty(d)&&(b.hasMany[d].mixin=a,h.hasMany[d]=b.hasMany[d])},l=a.entityDecoratorHooks;for(n=0;n<l.length;n++)l[n](j);return d[f]=j,j}function h(){var b,c,d,e;if(a.typeMapper&&a.typeMapper.newUuid)return a.typeMapper.newUuid();for(b=[],c="0123456789ABCDEF",d=0;32>d;d++)b[d]=c.substr(Math.floor(16*Math.random()),1);return b[12]="4",b[16]=c.substr(8|3&b[16],1),e=b.join("")}function i(b){if(a.typeMapper&&a.typeMapper.defaultValue)return a.typeMapper.defaultValue(b);switch(b){case"TEXT":return"";case"BOOL":return!1;default:return-1!==b.indexOf("INT")?0:-1!==b.indexOf("CHAR")?"":null}}function j(a,b){var d,e,c=a.length;for(d=0;c>d;d++){if(e=a[d],e.equals&&e.equals(b))return!0;if(e===b)return!0}return!1}function k(a,b){var d,e,c=a.length;for(d=0;c>d;d++){if(e=a[d],e.equals&&e.equals(b))return a.splice(d,1),void 0;if(e===b)return a.splice(d,1),void 0}}function l(a,b,c){this.obj=a,this.eventType=b,this.fn=c}function m(){this.subscribers={}}function n(){}function o(a,b){this.left=a,this.right=b}function p(a,b){this.left=a,this.right=b}function q(a,b,c){this.property=a,this.operator=b.toLowerCase(),this.value=c}function r(){}function s(a,b){this.init(a,b,s)}function t(a,b){this.init(a,b,t)}function u(b,c){this.init(b,c,a.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function v(b){this.init(a,null,v),this._items=b||[]}var c={},d={};a.getEntityMeta=function(){return c},a.trackedObjects={},a.objectsToRemove={},a.objectsRemoved=[],a.globalPropertyListeners={},a.queryCollectionCache={},a.getObjectsToRemove=function(){return this.objectsToRemove},a.getTrackedObjects=function(){return this.trackedObjects},a.entityDecoratorHooks=[],a.flushHooks=[],a.schemaSyncHooks=[],a.debug=!0,a.subscribeToGlobalPropertyListener=function(a,b,c){var e,f,d=b+"__"+c;if(d in this.globalPropertyListeners){for(e=this.globalPropertyListeners[d],f=0;f<e.length;f++)if(e[f]===a)return;this.globalPropertyListeners[d].push(a)}else this.globalPropertyListeners[d]=[a]},a.unsubscribeFromGlobalPropertyListener=function(a,b,c){var f,d=b+"__"+c,e=this.globalPropertyListeners[d];for(f=0;f<e.length;f++)if(e[f]===a)return e.splice(f,1),void 0},a.propertyChanged=function(a,b,c,d){var e,f,g,h,i,j,k,l;if(this.trackedObjects[a.id]&&(e=a._type,f=e+"__"+b,f in this.globalPropertyListeners))for(g=this.globalPropertyListeners[f],h=0;h<g.length;h++)i=g[h],j=a._data,j[b]=c,k=i._filter.match(j),j[b]=d,l=i._filter.match(j),k!=l&&i.triggerEvent("change",i,a)},a.objectRemoved=function(a){var c,d,e,b=a._type;if(this.queryCollectionCache[b]){c=this.queryCollectionCache[b];for(d in c)c.hasOwnProperty(d)&&(e=c[d],e._filter.match(a)&&e.triggerEvent("change",e,a))}},a.getMeta=e,f.prototype=a,a.Session=f,a.define=function(a,b){if(c[a]&&!b)return g(a);var d={name:a,fields:b,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};return c[a]=d,g(a)},a.isDefined=function(a){return!!c[a]},a.defineMixin=function(a,b){var c=this.define(a,b);return c.meta.isMixin=!0,c},a.isTransaction=function(a){return!a||a&&a.executeSql},a.isSession=function(a){return!a||a&&a.schemaSync},a.add=function(a){if(a){if(!this.trackedObjects[a.id]&&(this.trackedObjects[a.id]=a,a._new))for(var b in a._data)a._data.hasOwnProperty(b)&&this.propertyChanged(a,b,void 0,a._data[b]);return this}},a.remove=function(a){return a._new?delete this.trackedObjects[a.id]:(this.objectsToRemove[a.id]||(this.objectsToRemove[a.id]=a),this.objectsRemoved.push({id:a.id,entity:a._type})),this.objectRemoved(a),this},a.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={}},a.asyncForEach=function(a,b,c){function d(){var e=a.pop();b(e,function(b,e){a.length>0?d():c(b,e)})}a=a.slice(0),a.length>0?d():c()},a.asyncParForEach=function(a,b,c){var f,d=0,e=a.length;for(0===e&&c(),f=0;e>f;f++)b(a[f],function(a,b){d++,d===e&&c(a,b)})},a.jsonToEntityVal=function(a,b){if(!b)return a;switch(b){case"DATE":return"number"==typeof a?a>1e12?new Date(a):new Date(1e3*a):null;default:return a}},a.entityValToJson=function(a,b){if(!b)return a;switch(b){case"DATE":return a?(a=new Date(a),Math.round(a.getTime()/1e3)):null;default:return a}},a.dump=function(c,e,f){var h,i,g=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return!a||a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);if(c=g.tx,e=g.entities,f=g.callback,!e){e=[];for(h in d)d.hasOwnProperty(h)&&e.push(d[h])}i={},a.asyncParForEach(e,function(b,d){b.all().list(c,function(e){var f=[];a.asyncParForEach(e,function(d,e){var i,j,k,l,m,n,g={},h=b.meta.fields;for(i in h)h.hasOwnProperty(i)&&(g[i]=a.entityValToJson(d._data[i],h[i]));j=b.meta.hasOne;for(k in j)j.hasOwnProperty(k)&&(g[k]=d._data[k]);l=b.meta.hasMany,m=[];for(n in l)l.hasOwnProperty(n)&&m.push(n);a.asyncParForEach(m,function(b,e){var f=a.get(d,b);f.list(c,function(a){g[b]=a.map(function(a){return a.id}),e()})},function(){g.id=d.id,f.push(g),e()})},function(){i[b.meta.name]=f,d()})})},function(){f(i)})},a.load=function(c,d,e){var i,j,k,l,m,n,o,p,q,r,s,t,f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.dump,e=f.callback,i=[],j=this;for(k in d)if(d.hasOwnProperty(k))for(l=g(k),m=l.meta.fields,n=d[k],o=0;o<n.length;o++){p=n[o],q=new l,q.id=p.id;for(r in p)if(p.hasOwnProperty(r))if(a.isImmutable(r))q[r]=p[r];else if(l.meta.hasMany[r]){if(s=l.meta.hasMany[r],s.manyToMany&&l.meta.name<s.type.meta.name)continue;t=a.get(q,r),p[r].length>0&&p[r].forEach(function(a){i.push({Entity:l,coll:t,id:a})})}else a.set(q,r,a.jsonToEntityVal(p[r],m[r]));this.add(q)}j.flush(c,function(){a.asyncForEach(i,function(a,b){a.Entity.load(j,c,a.id,function(c){a.coll.add(c),b()})},function(){j.flush(c,e)})})},a.dumpToJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(a){return a&&a.length&&!a.apply},defaultValue:null},{name:"callback",optional:!1,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.entities,e=f.callback,this.dump(c,d,function(a){e(JSON.stringify(a))})},a.loadFromJson=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:b.isCallback(),defaultValue:function(){}}]);c=f.tx,d=f.jsonDump,e=f.callback,this.load(c,JSON.parse(d),e)},a.createUUID=h,l.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},m.prototype.addEventListener=function(a,b){return this.subscribers[a]||(this.subscribers[a]=[]),this.subscribers[a].push(b),new l(this,a,b)},m.prototype.removeEventListener=function(a,b){var d,c=this.subscribers[a];for(d=0;d<c.length;d++)if(c[d]==b)return this.subscribers[a].splice(d,1),!0;return!1},m.prototype.triggerEvent=function(a){var b,c;if(this.subscribers[a])for(b=this.subscribers[a].slice(0),c=0;c<b.length;c++)b[c].apply(null,arguments)},n.prototype.match=function(){return!0},n.prototype.makeFit=function(){},n.prototype.makeNotFit=function(){},n.prototype.toUniqueString=function(){return"NULL"},n.prototype.subscribeGlobally=function(){},n.prototype.unsubscribeGlobally=function(){},o.prototype.match=function(a){return this.left.match(a)&&this.right.match(a)},o.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},o.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},o.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},o.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},o.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},p.prototype.match=function(a){return this.left.match(a)||this.right.match(a)},p.prototype.makeFit=function(a){this.left.makeFit(a),this.right.makeFit(a)},p.prototype.makeNotFit=function(a){this.left.makeNotFit(a),this.right.makeNotFit(a)},p.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},p.prototype.subscribeGlobally=function(a,b){this.left.subscribeGlobally(a,b),this.right.subscribeGlobally(a,b)},p.prototype.unsubscribeGlobally=function(a,b){this.left.unsubscribeGlobally(a,b),this.right.unsubscribeGlobally(a,b)},q.prototype.match=function(b){var c=this.value,d=a.get(b,this.property);switch(c&&c.getTime&&(c=1e3*Math.round(c.getTime()/1e3),d&&d.getTime&&(d=1e3*Math.round(d.getTime()/1e3))),this.operator){case"=":return d===c;case"!=":return d!==c;case"<":return c>d;case"<=":return c>=d;case">":return d>c;case">=":return d>=c;case"in":return j(c,d);case"not in":return!j(c,d)}},q.prototype.makeFit=function(b){if("="!==this.operator)throw new Error("Sorry, can't perform makeFit for other filters than =");a.set(b,this.property,this.value)},q.prototype.makeNotFit=function(b){if("="!==this.operator)throw new Error("Sorry, can't perform makeNotFit for other filters than =");a.set(b,this.property,null)},q.prototype.subscribeGlobally=function(b,c){a.subscribeToGlobalPropertyListener(b,c,this.property)},q.prototype.unsubscribeGlobally=function(b,c){a.unsubscribeFromGlobalPropertyListener(b,c,this.property)},q.prototype.toUniqueString=function(){var a=this.value;return a&&a._type&&(a=a.id),this.property+this.operator+a},a.NullFilter=n,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q,a.uniqueQueryCollection=function(a){var c,b=a._entityName;return a._items?a:(this.queryCollectionCache[b]||(this.queryCollectionCache[b]={}),c=a.toUniqueString(),this.queryCollectionCache[b][c]||(this.queryCollectionCache[b][c]=a),this.queryCollectionCache[b][c])},r.prototype=new m,r.prototype.oldAddEventListener=r.prototype.addEventListener,r.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},r.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},r.prototype.addEventListener=function(a,b){var c=this,d=this.oldAddEventListener(a,b);return 1===this.subscribers[a].length&&this.setupSubscriptions(),d.oldUnsubscribe=d.unsubscribe,d.unsubscribe=function(){this.oldUnsubscribe(),0===c.subscribers[a].length&&c.teardownSubscriptions()},d},r.prototype.persistQueries=function(){return[]},r.prototype.init=function(b,c,d){this._filter=new n,this._orderColumns=[],this._prefetchFields=[],this._entityName=c,this._constructor=d,this._limit=-1,this._skip=0,this._reverse=!1,this._session=b||a,this.subscribers={}},r.prototype.toUniqueString=function(){var b,c,d,a=this._constructor.name+": "+this._entityName;for(a+="|Filter:",b=[],a+=this._filter.toUniqueString(),a+="|Values:",c=0;c<b.length;c++)a+=b+"|^|";for(a+="|Order:",c=0;c<this._orderColumns.length;c++)d=this._orderColumns[c],a+=d[0]+", "+d[1]+", "+d[2];for(a+="|Prefetch:",c=0;c<this._prefetchFields.length;c++)a+=this._prefetchFields[c];return a+="|Limit:",a+=this._limit,a+="|Skip:",a+=this._skip,a+="|Reverse:",a+=this._reverse},r.prototype.clone=function(a){var c,d,b=new this._constructor(this._session,this._entityName);if(b._filter=this._filter,b._prefetchFields=this._prefetchFields.slice(0),b._orderColumns=this._orderColumns.slice(0),b._limit=this._limit,b._skip=this._skip,b._reverse=this._reverse,a){c={};for(d in this.subscribers)this.subscribers.hasOwnProperty(d)&&(c[d]=this.subscribers[d].slice(0));b.subscribers=c}else b.subscribers=this.subscribers;return b},r.prototype.filter=function(a,b,c){var e,d=this.clone(!0);return d._filter=new o(this._filter,new q(a,b,c)),e=this._session,d=e.uniqueQueryCollection(d),e.uniqueQueryCollection(d)},r.prototype.or=function(a){var b=this.clone(!0);return b._filter=new p(this._filter,a),this._session.uniqueQueryCollection(b)},r.prototype.and=function(a){var b=this.clone(!0);return b._filter=new o(this._filter,a),this._session.uniqueQueryCollection(b)},r.prototype.order=function(a,b,c){b=void 0===b?!0:b,c=void 0===c?!0:c;var d=this.clone();return d._orderColumns.push([a,b,c]),this._session.uniqueQueryCollection(d)},r.prototype.limit=function(a){var b=this.clone();return b._limit=a,this._session.uniqueQueryCollection(b)},r.prototype.skip=function(a){var b=this.clone();return b._skip=a,this._session.uniqueQueryCollection(b)},r.prototype.reverse=function(){var a=this.clone();return a._reverse=!0,this._session.uniqueQueryCollection(a)},r.prototype.prefetch=function(a){var b=this.clone();return b._prefetchFields.push(a),this._session.uniqueQueryCollection(b)},r.prototype.selectJSON=function(c,d,e){var f=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),h=this._session,i=this;return c=f.tx,d=f.props,e=f.callback,c?(g(this._entityName),this.list(function(b){var f=[];a.asyncForEach(b,function(a,b){a.selectJSON(c,d,function(a){f.push(a),b()})},function(){e(f)})}),void 0):(h.transaction(function(a){i.selectJSON(a,d,e)}),void 0)},r.prototype.add=function(a){if(!a.id||!a._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(a),this._filter.makeFit(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},r.prototype.addAll=function(a){var b,c;for(b=0;b<a.length;b++)c=a[b],this._session.add(c),this._filter.makeFit(c),this.triggerEvent("add",this,c);this.triggerEvent("change",this)},r.prototype.remove=function(a){if(!a.id||!a._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},r.prototype.each=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:b.isCallback()}]);c=e.tx,d=e.eachFn,this.list(c,function(a){for(var b=0;b<a.length;b++)d(a[b])})},r.prototype.forEach=r.prototype.each,r.prototype.one=function(c,d){var e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:b.isCallback()}]);c=e.tx,d=e.oneFn,this.limit(1).list(c,function(a){0===a.length?d(null):d(a[0])})},s.prototype=new r,t.prototype=new s,t.prototype.add=function(a){this._session.add(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a)},t.prototype.remove=function(a){this._session.remove(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},u.prototype=new s,u.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},u.prototype.add=function(a){j(this._localAdded,a)||(this._session.add(a),this._localAdded.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},u.prototype.addAll=function(a){var b,c;for(b=0;b<a.length;b++)c=a[b],j(this._localAdded,c)||(this._session.add(c),this._localAdded.push(c),this.triggerEvent("add",this,c));this.triggerEvent("change",this)},u.prototype.clone=function(){var a=s.prototype.clone.call(this);return a._localAdded=this._localAdded,a._localRemoved=this._localRemoved,a._obj=this._obj,a._coll=this._coll,a},u.prototype.remove=function(a){j(this._localAdded,a)?k(this._localAdded,a):j(this._localRemoved,a)||this._localRemoved.push(a),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a)},v.prototype=new r,v.prototype.clone=function(){var a=s.prototype.clone.call(this);return a._items=this._items,a},v.prototype.add=function(a){j(this._items,a)||(this._session.add(a),this._items.push(a),this.triggerEvent("add",this,a),this.triggerEvent("change",this,a))},v.prototype.addAll=function(a){var b,c;for(b=0;b<a.length;b++)c=a[b],j(this._items,c)||(this._session.add(c),this._items.push(c),this.triggerEvent("add",this,c));this.triggerEvent("change",this)},v.prototype.remove=function(a){var c,b=this._items;for(c=0;c<b.length;c++)b[c]===a&&(this._items.splice(c,1),this.triggerEvent("remove",this,a),this.triggerEvent("change",this,a))},v.prototype.list=function(c,d){var f,g,h,i,e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);for(d=e.callback,(!d||d.executeSql)&&(d=arguments[1]),f=this._items.slice(0),g=this,h=[],i=0;i<f.length;i++)this._filter.match(f[i])&&h.push(f[i]);return h.sort(function(b,c){var d,e,f,h,i,j;for(d=0;d<g._orderColumns.length;d++){if(e=g._orderColumns[d][0],f=g._orderColumns[d][1],h=g._orderColumns[d][2],i=a.get(b,e),j=a.get(c,e),h||(i=i.toLowerCase(),j=j.toLowerCase()),j>i)return f?-1:1;if(i>j)return f?1:-1}return 0}),this._skip&&h.splice(0,this._skip),this._limit>-1&&(h=h.slice(0,this._limit)),this._reverse&&h.reverse(),d?(d(h),void 0):h},v.prototype.destroyAll=function(a){(!a||a.executeSql)&&(a=arguments[1]),this._items=[],this.triggerEvent("change",this),a&&a()},v.prototype.count=function(c,d){var f,e=b.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:b.isCallback()}]);return c=e.tx,d=e.callback,f=this.list(),d?(d(f.length),void 0):f.length},a.QueryCollection=r,a.DbQueryCollection=s,a.ManyToManyDbQueryCollection=u,a.LocalQueryCollection=v,a.Observable=m,a.Subscription=l,a.AndFilter=o,a.OrFilter=p,a.PropertyFilter=q}();var b={};return function(){b.getArgs=function(a,b){for(var f,g,c=0,d=0,e={};d<b.length;)if(f=b[d],g=a[c],f.optional)void 0!==g&&f.check(g)?(e[f.name]=g,c++,d++):(void 0!==f.defaultValue&&(e[f.name]=f.defaultValue),d++);else{if(f.check&&!f.check(g))throw new Error("Invalid value for argument: "+f.name+" Value: "+g);e[f.name]=g,d++,c++}return e},b.hasProperty=function(a){return function(b){return b&&void 0!==b[a]}},b.hasType=function(a){return function(b){return typeof b===a}},b.isCallback=function(){return function(a){return a&&a.apply}}}(),a.argspec=b,a}if("undefined"!=typeof exports){exports.createPersistence=function(){return initPersistence({})};var singleton;"function"==typeof exports.__defineGetter__?exports.__defineGetter__("persistence",function(){return singleton||(singleton=exports.createPersistence()),singleton}):Object.defineProperty(exports,"persistence",{get:function(){return singleton||(singleton=exports.createPersistence()),singleton},enumerable:!0,configurable:!0})}else window=window||{},window.persistence=initPersistence(window.persistence||{});"undefined"==typeof JSON&&(JSON={}),JSON.stringify||function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,h,g=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,h=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)h[c]=str(c,i)||"null";return e=0===h.length?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));return e=0===h.length?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();
// persistence.store.sql.js
function config(a,b){function d(b,c,d,e){var f,g,h,i,j,k;if(e=e||"",b.trackedObjects[d[e+"id"]])return b.trackedObjects[d[e+"id"]];if(f=a.typeMapper,g=a.getMeta(c),h=a.define(c),!d[e+"id"])return null;i=new h(b,void 0,!0),i.id=f.dbValToEntityVal(d[e+"id"],f.idType),i._new=!1;for(j in d)d.hasOwnProperty(j)&&j.substring(0,e.length)===e&&(k=j.substring(e.length),"id"!=k&&(i._data[k]=f.dbValToEntityVal(d[j],g.fields[k]||f.idType)));return i}function e(b,c,d){var l,m,n,e=a.getMeta(b._type),f=a.typeMapper,h=[],i=[],j=[],k=[];if(b._new)for(l in e.fields)e.fields.hasOwnProperty(l)&&(b._dirtyProperties[l]=!0);for(l in b._dirtyProperties)b._dirtyProperties.hasOwnProperty(l)&&(h.push("`"+l+"`"),m=e.fields[l]||f.idType,i.push(f.entityValToDbVal(b._data[l],m)),j.push(f.outVar("?",m)),k.push("`"+l+"` = "+f.outVar("?",m)));if(n=[],e&&e.hasMany)for(l in e.hasMany)e.hasMany.hasOwnProperty(l)&&(n=n.concat(a.get(b,l).persistQueries()));g(c,n,function(){var a;return b._new||0!==h.length?(b._dirtyProperties={},b._new?(h.push("id"),i.push(f.entityIdToDbId(b.id)),j.push(f.outIdVar("?")),a="INSERT INTO `"+b._type+"` ("+h.join(", ")+") VALUES ("+j.join(", ")+")",b._new=!1,c.executeSql(a,i,d,d)):(a="UPDATE `"+b._type+"` SET "+k.join(",")+" WHERE id = "+f.outId(b.id),c.executeSql(a,i,d,d)),void 0):(d&&d(),void 0)})}function f(b,c,d){var i,j,e=a.getMeta(b._type),f=a.typeMapper,h=[["DELETE FROM `"+b._type+"` WHERE id = "+f.outId(b.id),null]];for(i in e.hasMany)e.hasMany.hasOwnProperty(i)&&e.hasMany[i].manyToMany&&(j=e.hasMany[i].tableName,h.push(["DELETE FROM `"+j+"` WHERE `"+e.name+"_"+i+"` = "+f.outId(b.id),null]));g(c,h,d)}function g(b,c,d){var f,e=[];for(f=3;f<arguments.length;f++)e.push(arguments[f]);a.asyncForEach(c,function(a,c){b.executeSql(a[0],a[1],c,function(a,b){console.log(b.message),c(a,b)})},function(a,b){return b&&d?(d(a,b),void 0):(d&&d.apply(null,e),void 0)})}var h,i,j,c=a.argspec;a.typeMapper=b.typeMapper||defaultTypeMapper,a.generatedTables={},a.schemaSync=function(d,e,f){var i,k,l,m,n,j,o,p,q,r,s,t,u,v,w,x,y,h=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:c.hasType("boolean")}]);if(d=h.tx,e=h.callback,f=h.emulate,!d)return i=this,this.transaction(function(a){i.schemaSync(a,e,f)}),void 0;j=[],o=a.typeMapper,p=a.getEntityMeta();for(q in p)if(p.hasOwnProperty(q)){if(k=p[q],!k.isMixin){l=[];for(r in k.fields)k.fields.hasOwnProperty(r)&&l.push([r,k.fields[r]]);for(s in k.hasOne)k.hasOne.hasOwnProperty(s)&&(m=k.hasOne[s].type.meta,l.push([s,o.idType]),j.push([b.createIndex(k.name,[s]),null]));for(t=0;t<k.indexes.length;t++)j.push([b.createIndex(k.name,k.indexes[t].columns,k.indexes[t]),null])}for(s in k.hasMany)if(k.hasMany.hasOwnProperty(s)&&k.hasMany[s].manyToMany&&(n=k.hasMany[s].tableName,!a.generatedTables[n])){if(m=k.hasMany[s].type.meta,u=k.hasMany[s].inverseProperty,m.hasMany[u].type.meta!=k)continue;v=k.name+"_"+s,w=m.name+"_"+u,j.push([b.createIndex(n,[v]),null]),j.push([b.createIndex(n,[w]),null]),x=[[v,o.idType],[w,o.idType]],k.isMixin&&x.push([v+"_class",o.classNameType]),m.isMixin&&x.push([w+"_class",o.classNameType]),j.push([b.createTable(n,x),null]),a.generatedTables[n]=!0}k.isMixin||(l.push(["id",o.idType,"PRIMARY KEY"]),a.generatedTables[k.name]=!0,j.push([b.createTable(k.name,l),null]))}for(y=a.schemaSyncHooks,t=0;t<y.length;t++)y[t](d);f?e(d):g(d,j,function(a,b){e(d,b)})},a.flush=function(b,d){var h,i,g=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:null}]);return b=g.tx,d=g.callback,h=this,b?(i=a.flushHooks,a.asyncForEach(i,function(a,c){a(h,b,c)},function(){var g,i,j,c=[];for(g in h.trackedObjects)h.trackedObjects.hasOwnProperty(g)&&c.push(h.trackedObjects[g]);i=[];for(g in h.objectsToRemove)h.objectsToRemove.hasOwnProperty(g)&&(i.push(h.objectsToRemove[g]),delete h.trackedObjects[g]);if(h.objectsToRemove={},d)a.asyncParForEach(i,function(a,c){f(a,b,c)},function(f,g){return g?d(f,g):(a.asyncParForEach(c,function(a,c){e(a,b,c)},d),void 0)});else{for(j=0;j<c.length;j++)e(c[j],b);for(j=0;j<i.length;j++)f(i[j],b)}}),void 0):(this.transaction(function(a){h.flush(a,d)}),void 0)},a.reset=function(b,d){var f,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);return b=e.tx,d=e.callback,f=this,b?(this.schemaSync(b,function(){function g(){var a=c.pop();b.executeSql("DROP TABLE IF EXISTS `"+a+"`",null,function(){c.length>0?g():h()},h)}function h(b,c){f.clean(),a.generatedTables={},d&&d(b,c)}var e,c=[];for(e in a.generatedTables)a.generatedTables.hasOwnProperty(e)&&c.push(e);c.length>0?g():h()},!0),void 0):(f.transaction(function(a){f.reset(a,d)}),void 0)},a.save=e,a.executeQueriesSeq=g,a.QueryCollection.prototype.persistQueries=function(){return[]},h=a.QueryCollection.prototype.clone,a.QueryCollection.prototype.clone=function(a){var b=h.call(this,a);return b._additionalJoinSqls=this._additionalJoinSqls.slice(0),b._additionalWhereSqls=this._additionalWhereSqls.slice(0),b._additionalGroupSqls=this._additionalGroupSqls.slice(0),b._manyToManyFetch=this._manyToManyFetch,b},i=a.QueryCollection.prototype.init,a.QueryCollection.prototype.init=function(a,b,c){i.call(this,a,b,c),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]},j=a.QueryCollection.prototype.toUniqueString,a.QueryCollection.prototype.toUniqueString=function(){var b,a=j.call(this);for(a+="|JoinSQLs:",b=0;b<this._additionalJoinSqls.length;b++)a+=this._additionalJoinSqls[b];for(a+="|WhereSQLs:",b=0;b<this._additionalWhereSqls.length;b++)a+=this._additionalWhereSqls[b];for(a+="|GroupSQLs:",b=0;b<this._additionalGroupSqls.length;b++)a+=this._additionalGroupSqls[b];return this._manyToManyFetch&&(a+="|ManyToManyFetch:",a+=JSON.stringify(this._manyToManyFetch)),a},a.NullFilter.prototype.sql=function(){return"1=1"},a.AndFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" AND "+this.right.sql(a,b,c)+")"},a.OrFilter.prototype.sql=function(a,b,c){return"("+this.left.sql(a,b,c)+" OR "+this.right.sql(a,b,c)+")"},a.PropertyFilter.prototype.sql=function(b,c,d){var h,i,j,k,e=a.typeMapper,f=c?"`"+c+"`.":"",g=b.fields[this.property]||e.idType;if("="===this.operator&&null===this.value)return f+"`"+this.property+"` IS NULL";if("!="===this.operator&&null===this.value)return f+"`"+this.property+"` IS NOT NULL";if("in"===this.operator){for(h=this.value,i=[],j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return 0===h.length?"1 = 0":f+"`"+this.property+"` IN ("+i.join(", ")+")"}if("not in"===this.operator){for(h=this.value,i=[],j=0;j<h.length;j++)i.push("?"),d.push(e.entityValToDbVal(h[j],g));return 0===h.length?"1 = 1":f+"`"+this.property+"` NOT IN ("+i.join(", ")+")"}return k=this.value,(k===!0||k===!1)&&(k=k?1:0),d.push(e.entityValToDbVal(k,g)),f+"`"+this.property+"` "+this.operator+" "+e.outVar("?",g)},a.DbQueryCollection.prototype.list=function(b,e){function m(a,b,c){var e,d=[k.inIdVar("`"+b+"`.id")+" AS "+c+"id"];for(e in a.fields)a.fields.hasOwnProperty(e)&&d.push(k.inVar("`"+b+"`.`"+e+"`",a.fields[e])+" AS `"+c+e+"`");for(e in a.hasOne)a.hasOne.hasOwnProperty(e)&&d.push(k.inIdVar("`"+b+"`.`"+e+"`")+" AS `"+c+e+"`");return d}var g,h,i,j,k,l,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,f=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);if(b=f.tx,e=f.callback,g=this,h=this._session,!b)return h.transaction(function(a){g.list(a,e)}),void 0;if(i=this._entityName,j=a.getMeta(i),k=a.typeMapper,j.isMixin)return l=[],a.asyncForEach(j.mixedIns,function(a,c){var d=g.clone();d._entityName=a.name,d.list(b,function(a){l=l.concat(a),c()})},function(){var b=new a.LocalQueryCollection(l);b._orderColumns=g._orderColumns,b._reverse=g._reverse,b.list(null,e)}),void 0;for(f=[],n=i+"_",o="root",p=m(j,o,n),q="",r=this._additionalWhereSqls.slice(0),s=this._manyToManyFetch,s&&(q+="LEFT JOIN `"+s.table+"` AS mtm ON mtm.`"+s.inverseProp+"` = `root`.`id` ",r.push("mtm.`"+s.prop+"` = "+k.outId(s.id))),q+=this._additionalJoinSqls.join(" "),t=0;t<this._prefetchFields.length;t++){if(u=this._prefetchFields[t].split("."),v=u[0],w=i,u.length>1&&(v=u[1],w=u[0]),x=a.getMeta(w),y=x.hasOne[v].type.meta,y.isMixin)throw new Error("cannot prefetch a mixin");z=y.name+"_"+v+"_tbl",A=o,u.length>1&&(A=w+"_"+w+"_tbl"),p=p.concat(m(y,z,v+"_")),q+="LEFT JOIN `"+y.name+"` AS `"+z+"` ON `"+z+"`.`id` = `"+A+"`.`"+v+"` "}B="WHERE "+[this._filter.sql(j,o,f)].concat(r).join(" AND "),C="SELECT "+p.join(", ")+" FROM `"+i+"` AS `"+o+"` "+q+" "+B,this._additionalGroupSqls.length>0&&(C+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(C+=" ORDER BY "+this._orderColumns.map(function(a){return(a[2]?"`":"LOWER(`")+n+a[0]+(a[2]?"` ":"`) ")+(a[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(C+=" LIMIT "+this._limit),this._skip>0&&(C+=" OFFSET "+this._skip),h.flush(b,function(){b.executeSql(C,f,function(b){var f,j,k,l,m,o,p,q,r,c=[];for(g._reverse&&b.reverse(),f=0;f<b.length;f++){for(j=b[f],k=d(h,i,j,n),l=0;l<g._prefetchFields.length;l++)m=g._prefetchFields[l].split("."),o=m[0],p=i,m.length>1&&(o=m[1],p=m[0]),q=a.getMeta(p),r=q.hasOne[o].type.meta,k._data_obj[o]=d(h,r.name,j,o+"_"),h.add(k._data_obj[o]);c.push(k),h.add(k)}e(c),g.triggerEvent("list",g,c)})})},a.DbQueryCollection.prototype.destroyAll=function(b,d){var f,g,h,i,j,k,l,m,n,o,p,q,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);return b=e.tx,d=e.callback,f=this,g=this._session,b?(h=this._entityName,i=a.getMeta(h),j=a.typeMapper,i.isMixin?(a.asyncForEach(i.mixedIns,function(a){var e=f.clone();e._entityName=a.name,e.destroyAll(b,d)},d),void 0):(k="",l=this._additionalWhereSqls.slice(0),m=this._manyToManyFetch,m&&(k+="LEFT JOIN `"+m.table+"` AS mtm ON mtm.`"+m.inverseProp+"` = `root`.`id` ",l.push("mtm.`"+m.prop+"` = "+j.outId(m.id))),k+=this._additionalJoinSqls.join(" "),e=[],n="WHERE "+[this._filter.sql(i,null,e)].concat(l).join(" AND "),o="SELECT id FROM `"+h+"` "+k+" "+n,p="DELETE FROM `"+h+"` "+k+" "+n,q=e.slice(0),g.flush(b,function(){b.executeSql(o,e,function(a){for(var c=0;c<a.length;c++)delete g.trackedObjects[a[c].id],g.objectsRemoved.push({id:a[c].id,entity:h});f.triggerEvent("change",f),b.executeSql(p,q,d,d)},d)}),void 0)):(g.transaction(function(a){f.destroyAll(a,d)}),void 0)},a.DbQueryCollection.prototype.count=function(b,d){var f,g,h,i,j,k,l,m,n,o,p,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);return b=e.tx,d=e.callback,f=this,g=this._session,b&&!b.executeSql&&(d=b,b=null),b?(h=this._entityName,i=a.getMeta(h),j=a.typeMapper,i.isMixin?(k=0,a.asyncForEach(i.mixedIns,function(a,c){var d=f.clone();d._entityName=a.name,d.count(b,function(a){k+=a,c()})},function(){d(k)}),void 0):(l="",m=this._additionalWhereSqls.slice(0),n=this._manyToManyFetch,n&&(l+="LEFT JOIN `"+n.table+"` AS mtm ON mtm.`"+n.inverseProp+"` = `root`.`id` ",m.push("mtm.`"+n.prop+"` = "+j.outId(n.id))),l+=this._additionalJoinSqls.join(" "),e=[],o="WHERE "+[this._filter.sql(i,"root",e)].concat(m).join(" AND "),p="SELECT COUNT(*) AS cnt FROM `"+h+"` AS `root` "+l+" "+o,g.flush(b,function(){b.executeSql(p,e,function(a){d(parseInt(a[0].cnt,10))})}),void 0)):(g.transaction(function(a){f.count(a,d)}),void 0)},a.ManyToManyDbQueryCollection.prototype.persistQueries=function(){var j,k,l,m,b=[],c=a.getMeta(this._obj._type),d=c.hasMany[this._coll].type.meta,e=a.typeMapper,f=c.hasMany[this._coll],g=d.hasMany[f.inverseProperty],h=f.mixin?f.mixin.meta.name:c.name,i=g.mixin?g.mixin.meta.name:d.name;for(j=0;j<this._localAdded.length;j++)k=[h+"_"+this._coll,i+"_"+f.inverseProperty],l=[e.outIdVar("?"),e.outIdVar("?")],m=[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localAdded[j].id)],f.mixin&&(k.push(h+"_"+this._coll+"_class"),l.push("?"),m.push(c.name)),g.mixin&&(k.push(i+"_"+f.inverseProperty+"_class"),l.push("?"),m.push(d.name)),b.push(["INSERT INTO "+f.tableName+" (`"+k.join("`, `")+"`) VALUES ("+l.join(",")+")",m]);for(this._localAdded=[],j=0;j<this._localRemoved.length;j++)b.push(["DELETE FROM  "+f.tableName+" WHERE `"+h+"_"+this._coll+"` = "+e.outIdVar("?")+" AND `"+i+"_"+f.inverseProperty+"` = "+e.outIdVar("?"),[e.entityIdToDbId(this._obj.id),e.entityIdToDbId(this._localRemoved[j].id)]]);return this._localRemoved=[],b}}var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(a){switch(a){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return a}},inVar:function(a){return a},outVar:function(a){return a},outId:function(a){return"'"+a+"'"},dbValToEntityVal:function(a,b){if(null===a||void 0===a)return a;switch(b){case"DATE":return a>1e12?new Date(parseInt(a,10)):new Date(1e3*parseInt(a,10));case"BOOL":return 1===a||"1"===a;case"INT":return+a;case"BIGINT":return+a;case"JSON":return a?JSON.parse(a):a;default:return a}},entityValToDbVal:function(a,b){return void 0===a||null===a?null:"JSON"===b&&a?JSON.stringify(a):a.id?a.id:"BOOL"===b?"false"===a?0:a?1:0:"DATE"===b||a.getTime?(a=new Date(a),Math.round(a.getTime()/1e3)):"VARCHAR(32)"===b?a.toString():a},inIdVar:function(a){return this.inVar(a,this.idType)},outIdVar:function(a){return this.outVar(a,this.idType)},entityIdToDbId:function(a){return this.entityValToDbVal(a,this.idType)}};"undefined"!=typeof exports?(exports.defaultTypeMapper=defaultTypeMapper,exports.config=config):(window=window||{},window.persistence=window.persistence||persistence||{},window.persistence.store=window.persistence.store||{},window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config});
// persistence.store.websql.js
try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.websql={},persistence.store.websql.config=function(a,b,c,d){var e=null;if(a.transaction=function(a){if(!e)throw new Error("No ongoing database connection, please connect first.");e.transaction(a)},a.db=a.db||{},a.db.implementation="unsupported",a.db.conn=null,window&&window.openDatabase)a.db.implementation="html5";else if(window&&window.google&&google.gears)a.db.implementation="gears";else try{openDatabaseSync&&(a.db.implementation="html5-sync")}catch(f){}if(a.db.html5={},a.db.html5.connect=function(b,c,d){var e={},f=openDatabase(b,"1.0",c,d);return e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5.transaction(c))})},e},a.db.html5.transaction=function(b){var c={};return c.executeSql=function(c,d,e,f){a.debug&&console.log(c,d),b.executeSql(c,d,function(a,b){var c,d;if(e){for(c=[],d=0;d<b.rows.length;d++)c.push(b.rows.item(d));e(c)}},f)},c},a.db.html5Sync={},a.db.html5Sync.connect=function(b,c,d){var e={},f=openDatabaseSync(b,"1.0",c,d);return e.transaction=function(b){return f.transaction(function(c){return b(a.db.html5Sync.transaction(c))})},e},a.db.html5Sync.transaction=function(b){var c={};return c.executeSql=function(c,d,e){var g,h,i;if(null==d&&(d=[]),a.debug&&console.log(c,d),g=b.executeSql(c,d),g&&e){for(h=[],i=0;i<g.rows.length;i++)h.push(g.rows.item(i));e(h)}},c},a.db.gears={},a.db.gears.connect=function(b){var c={},d=google.gears.factory.create("beta.database");return d.open(b),c.transaction=function(b){b(a.db.gears.transaction(d))},c},a.db.gears.transaction=function(b){var c={};return c.executeSql=function(c,d,e){var g,h,i,j;if(a.debug&&console.log(c,d),g=b.execute(c,d),e){for(h=[];g.isValidRow();){for(i={},j=0;j<g.fieldCount();j++)i[g.fieldName(j)]=g.field(j);h.push(i),g.next()}e(h)}},c},a.db.connect=function(b,c,d){return"html5"==a.db.implementation?a.db.html5.connect(b,c,d):"html5-sync"==a.db.implementation?a.db.html5Sync.connect(b,c,d):"gears"==a.db.implementation?a.db.gears.connect(b):void 0},a.store.websql.sqliteDialect={createTable:function(b,c){var g,h,d=a.typeMapper,e="CREATE TABLE IF NOT EXISTS `"+b+"` (",f=[];for(g=0;g<c.length;g++)h=c[g],f.push("`"+h[0]+"` "+d.columnType(h[1])+(h[2]?" "+h[2]:""));return e+=f.join(", "),e+=")"},createIndex:function(a,b,c){return c=c||{},"CREATE "+(c.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+a+"__"+b.join("_")+"` ON `"+a+"` ("+b.map(function(a){return"`"+a+"`"}).join(", ")+")"}},a.store.sql.config(a,a.store.websql.sqliteDialect),e=a.db.connect(b,c,d),!e)throw new Error("No supported database found in this browser.")};try{exports.persistence=persistence}catch(e){};
// persistence.store.memory.js
try{window||(window={})}catch(e){window={},exports.console=console}var persistence=window&&window.persistence?window.persistence:{};persistence.store||(persistence.store={}),persistence.store.memory={},persistence.store.memory.config=function(a,b){function g(b){var c=d[b._entityName];return c||(c=new a.LocalQueryCollection),c=c.clone(),c._filter=b._filter,c._prefetchFields=b._prefetchFields,c._orderColumns=b._orderColumns,c._limit=b._limit,c._skip=b._skip,c._reverse=b._reverse,c}var d,e,f,c=a.argspec;b=b||"persistenceData",d={},a.getAllObjects=function(){return d},e=a.add,a.add=function(b){if(!this.trackedObjects[b.id]){e.call(this,b);var c=b._type;d[c]||(d[c]=new a.LocalQueryCollection,d[c]._session=a),d[c].add(b)}return this},f=a.remove,a.remove=function(a){f.call(this,a);var b=a._type;d[b].remove(a)},a.schemaSync=function(){var f=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:c.hasType("boolean")}]);f.callback()},a.flush=function(b){var e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]),f=a.flushHooks,g=this;a.asyncForEach(f,function(a,c){a(g,b,c)},function(){var c,b=a.trackedObjects;for(c in b)b.hasOwnProperty(c)&&(a.objectsToRemove.hasOwnProperty(c)?delete b[c]:b[c]._dirtyProperties={});e.callback()})},a.transaction=function(a){setTimeout(function(){a({executeSql:function(){}})},0)},a.loadFromLocalStorage=function(a){var c=window.localStorage.getItem(b);c?this.loadFromJson(c,a):a&&a()},a.saveToLocalStorage=function(a){this.dumpToJson(function(c){window.localStorage.setItem(b,c),a&&a()})},a.reset=function(b,e){var f=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=f.tx,e=f.callback,d={},this.clean(),e()},a.close=function(){},a.DbQueryCollection.prototype.list=function(b,d){var f,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=e.tx,d=e.callback,f=g(this),f.list(null,d)},a.DbQueryCollection.prototype.destroyAll=function(b,d){var f,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);b=e.tx,d=e.callback,f=g(this),f.destroyAll(null,d)},a.DbQueryCollection.prototype.count=function(b,d){var f,e=c.getArgs(arguments,[{name:"tx",optional:!0,check:a.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);b=e.tx,d=e.callback,f=g(this),f.count(null,d)},a.ManyToManyDbQueryCollection=function(b,c){this.init(b,c,a.ManyToManyDbQueryCollection),this._items=[]},a.ManyToManyDbQueryCollection.prototype=new a.LocalQueryCollection,a.ManyToManyDbQueryCollection.prototype.initManyToMany=function(a,b){this._obj=a,this._coll=b},a.ManyToManyDbQueryCollection.prototype.add=function(b,c){var d,e;a.LocalQueryCollection.prototype.add.call(this,b),c||(d=a.getMeta(this._obj._type),e=d.hasMany[this._coll].inverseProperty,a.get(b,e).add(this._obj,!0))},a.ManyToManyDbQueryCollection.prototype.remove=function(b,c){var d,e;a.LocalQueryCollection.prototype.remove.call(this,b),c||(d=a.getMeta(this._obj._type),e=d.hasMany[this._coll].inverseProperty,a.get(b,e).remove(this._obj,!0))}};try{exports.config=persistence.store.memory.config,exports.getSession=function(){return persistence}}catch(e){};